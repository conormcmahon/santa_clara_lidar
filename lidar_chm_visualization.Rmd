---
title: "LiDAR CHM Visualization"
author: "Conor McMahon"
date: "11/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(raster)
library(rgdal)
library(here)
library(rasterKernelEstimates)

```

First, load the two LiDAR canopy height models and display them for visual comparison, after running a filter to remove powerlines:

First dataset information:
- first flight on October 18, 2015 the second on October 19, 2015, and a short final mission was flown on October 20, 2015
- 1 km wide, 125 km long, about 136 km^3 total area
- 10 to 45 pts/m^2
Second dataset information:
- flights from 05/27/2018 - 07/22/2018
- about 7423 km^2
- 5.92 pts/m^3

```{r load_filter_chms, echo=FALSE, warning=FALSE}

pre_drought_chm <- raster(here::here("data","chm_mosaic_2015.tif"))
post_drought_chm <- raster(here::here("data","chm_mosaic_2018.tif"))

# Filter to remove power lines
#    get PERCENTILEth percentile of heights among neighbors to each pixel
#    assign NA to pixels which have height more than HEIGHT_THRESHOLD above the PERCENTILEth percentile in neighbors
#    neighbors are all points within KERNEL_HALFWIDTH cells (including along diagonals) except target point
filterPowerLines <- function(input_raster, kernel_halfwidth, percentile, height_threshold)
{
  # Weights matrix is for 24 nearest neighbors
  kernel_width <- (kernel_halfwidth*2+1)
  weights <- matrix(1,nrow=kernel_width, ncol=kernel_width)
  weights[kernel_halfwidth+1,kernel_halfwidth+1] <- 0
  run.time <- proc.time()
  kernel_percentiles <- rasterLocalQuantiles(input_raster,weights,q=percentile)
  
  powerline_mask <- (input_raster - kernel_percentiles) > height_threshold
  
  return(mask(input_raster, powerline_mask, maskvalue=1, updatevalue=NA))
}

# Here, using 70th percentile, kernels 25 pixels on a side (25 m), and a height threshold of 10
pre_drought_chm <- filterPowerLines(pre_drought_chm, 12, 70, 10)
writeRaster(pre_drought_chm, here::here("outputs","chm_mosaic_2015_filtered.tif"), overwrite=TRUE)
post_drought_chm <- filterPowerLines(post_drought_chm, 12, 70, 10)
writeRaster(post_drought_chm, here::here("outputs","chm_mosaic_2018_filtered.tif"), overwrite=TRUE)

plot(pre_drought_chm, zlim=c(0,30))
plot(post_drought_chm, zlim=c(0,30))

```

Next, aggregate to five meters and mask both images to the same extent, then compare changes:

```{r aggregate_mask_change_detection, echo=FALSE, warning=FALSE}

source(here::here("aggregate_custom.R"))

# Aggregate up to 5m resolution
crs(pre_drought_chm) <- crs("+init=epsg:32611")
pre_drought_chm_5m <- aggregate(pre_drought_chm, fact=5, fun=mean)
post_drought_chm_5m <- aggregate_custom(post_drought_chm, pre_drought_chm_5m)

pre_drought_mask <- pre_drought_chm_5m != 0
post_drought_mask <- post_drought_chm_5m != 0

pre_drought_chm_5m_masked <- mask(mask(mask(pre_drought_chm_5m, post_drought_chm_5m, maskvalue=0), post_drought_chm_5m), pre_drought_chm_5m, maskvalue=0)
post_drought_chm_5m_masked <- mask(mask(mask(post_drought_chm_5m, pre_drought_chm_5m, maskvalue=0), pre_drought_chm_5m), post_drought_chm_5m, maskvalue=0)
writeRaster(pre_drought_chm_5m_masked, here::here("outputs","chm_2015_5m.tif"))
writeRaster(post_drought_chm_5m_masked, here::here("outputs","chm_2018_5m.tif"))


# plot(pre_drought_chm_5m)
# plot(post_drought_chm_5m)
# plot(pre_drought_mask)
# plot(post_drought_mask)

# Get Change in CHM from 2015 to 2018
drought_change <- (post_drought_chm_5m - pre_drought_chm_5m) * pre_drought_mask * post_drought_mask
drought_change[drought_change == 0] <- NA
plot(drought_change, zlim=c(-10,10))

# Crop scenes to match same extent
drought_change <- crop(drought_change, pre_drought_chm_5m)
pre_drought_chm_5m <- crop(pre_drought_chm_5m, drought_change)

pre_drought_chm_df <- as.data.frame(pre_drought_chm_5m, xy=TRUE)
names(pre_drought_chm_df) <- c("x", "y", "chm_init")
drought_change_df <- as.data.frame(drought_change, xy=TRUE)
names(drought_change_df) <- c("x", "y","chm_change")
drought_change_df$chm_init <- pre_drought_chm_df$chm_init

ggplot(drought_change_df) + 
  geom_histogram(aes(x=chm_change))

writeRaster(drought_change, here::here("outputs","chm_change_overall.tif"), overwrite=TRUE)

```

Compare change between sites



```{r site_level_change, echo=FALSE, warning=FALSE}

study_regions <- readOGR(here::here("boundaries","study_sites_feb25.shp"))
woodland <- study_regions[study_regions$name == "Woodland",]
channel <- study_regions[study_regions$name == "Channel",]
restoration <- study_regions[study_regions$name == "Restoration",]
#woodland <- readOGR(here::here("boundaries","east_grove_woodland.shp"))
#hannel <- readOGR(here::here("boundaries","channel_SCR.shp"))

channel_change <- mask(drought_change, channel)
woodland_change <- mask(drought_change, woodland)
restoration_change <- mask(drought_change, restoration)

writeRaster(channel_change, here::here("outputs","channel_change.tif"), overwrite=TRUE)
writeRaster(woodland_change, here::here("outputs","woodland_change.tif"), overwrite=TRUE)
writeRaster(restoration_change, here::here("outputs","restoration_change.tif"), overwrite=TRUE)

channel_change_df <- as.data.frame(channel_change, xy=TRUE) %>%
  drop_na() %>%
  mutate(scene = rep("channel", n()))
woodland_change_df <- as.data.frame(woodland_change, xy=TRUE) %>%
  drop_na() %>%
  mutate(scene = rep("woodland", n()))
restoration_change_df <- as.data.frame(restoration_change, xy=TRUE) %>%
  drop_na() %>%
  mutate(scene = rep("restoration", n()))
change_df <- rbind(channel_change_df, woodland_change_df, restoration_change_df)

ggplot(change_df) + 
  geom_histogram(aes(x=layer, group=scene, col=scene), bins=100) + 
  scale_x_continuous(limits=c(-30,15)) + 
  scale_y_log10() + 
  ggtitle("CHM Change Across Entire Study Area")

ggplot(channel_change_df) + 
  geom_histogram(aes(x=layer, group=scene, col=scene), bins=100) + 
  scale_x_continuous(limits=c(-30,15)) + 
  scale_y_log10() + 
  ggtitle("CHM Change along Channel")

ggplot(woodland_change_df) + 
  geom_histogram(aes(x=layer, group=scene, col=scene), bins=100) + 
  scale_x_continuous(limits=c(-30,15)) + 
  scale_y_log10() + 
  ggtitle("CHM Change in Woodland")

ggplot(restoration_change_df) + 
  geom_histogram(aes(x=layer, group=scene, col=scene), bins=100) + 
  scale_x_continuous(limits=c(-30,15)) + 
  scale_y_log10() + 
  ggtitle("CHM Change in Restored Area")



```


Interested in comapring histograms across time...


```{r histogram_correlations, warning=FALSE}

# Load the two datasets
histogram_2015 <- stack(here::here("outputs","histogram_2015_mosaic.tif"))
histogram_2018 <- stack(here::here("outputs","histogram_2018_mosaic.tif"))
# Crop to same extent
histogram_2015 <- crop(histogram_2015, histogram_2018)
histogram_2018 <- crop(histogram_2018, histogram_2015)
# Mask to remove values which are empty in one raster
mask_2015 <- 1-is.na(histogram_2015[[1]])
mask_2018 <- 1-is.na(histogram_2018[[1]])
mask_overall <- mask_2015*mask_2018
histogram_2015 <- histogram_2015*mask_overall
histogram_2018 <- histogram_2018*mask_overall

# Combine histogram values to one image (first two bands relate to min/max of histogram range...)
histograms_combined <- stack(histogram_2015[[3:22]], histogram_2018[[3:22]])

# Sourced code for this part from obrl_soil answer at https://gis.stackexchange.com/questions/279535/pixel-correlations-from-two-raster-datasets-in-r

# Function to generate correlation between 20 initial and 20 following values for a given pixel
corvec <- function(vec = NULL) {
  cor(
    # first LiDAR histogram (2015)
    x      = vec[1:(length(vec)/2)],
    # second LiDAR histogram (2018)
    y      = vec[((length(vec)/2) + 1):length(vec)],
    use    = 'complete.obs',
    method = 'spearman'
  )
}

# Run the above function for each cell in the raster
histogram_correlation <- calc(
  histograms_combined,
  fun = function(x) {
    # skip all areas where at least one band in the cell is NA in at least one of the images
    if (sum(is.na(x)) > 0) {
      NA_real_
    } else {
      corvec(vec = x)
    }
  }
)

plot(histogram_correlation, zlim=c(0,1))

writeRaster(histogram_correlation, here::here("outputs","histogram_correlation.tif"), overwrite=TRUE)

woodland_histogram_correlation <- mask(histogram_correlation, woodland)
channel_histogram_correlation <- mask(histogram_correlation, channel)
restoration_histogram_correlation <- mask(histogram_correlation, restoration)
writeRaster(woodland_histogram_correlation, here::here("outputs","woodland_histogram_correlation.tif"), overwrite=TRUE)
writeRaster(channel_histogram_correlation, here::here("outputs","channel_histogram_correlation.tif"), overwrite=TRUE)
writeRaster(restoration_histogram_correlation, here::here("outputs","restoration_histogram_correlation.tif"), overwrite=TRUE)

```


Now we'll make violin plots showing before and after height conditions by region:


```{r height_violin_plots, warning=FALSE}

histogram_all <- crop(histogram_2015[[3:22]], histogram_2018)
histogram_all <- stack(histogram_all, crop(histogram_2018[[3:22]], histogram_2015))
histogram_all_df <- as.data.frame(histogram_all)

makeBoxPlot <- function (histogram_data, site_mask, site_name)
{
  site_histogram <- as.data.frame(mask(crop(histogram_data, site_mask), site_mask, updatevalue=NA))
  names(site_histogram) <- c(paste("bin_",1:20,sep=""),
                             paste("bin_",1:20,sep=""))
  site_histogram_pre <- site_histogram[,1:20]
  site_histogram_post <- site_histogram[,21:40]
  
  site_histogram_pre_longer <- site_histogram_pre %>%
    pivot_longer(1:20,names_to="name",values_to="frequency") %>%
    mutate(site = rep(site_name, n()), 
           year = 2015)
  site_histogram_post_longer <- site_histogram_post %>%
    pivot_longer(1:20,names_to="name",values_to="frequency") %>%
    mutate(site = rep(site_name, n()), 
           year = 2018)
  
  all_data <- rbind(site_histogram_pre_longer, 
                    site_histogram_post_longer) %>%
    drop_na() %>%
    mutate(bin = as.numeric(substr(name, 5,10)))
  
  ggplot(data=all_data) + 
    geom_boxplot(aes(y=frequency, x=bin*1.5, group=interaction(year,bin), col=as.factor(year)), outlier.alpha=0) + 
    ylab("Height (m) ") + 
    xlab("Frequency") +     guides(col=guide_legend(title="Year")) + 
    ggtitle(paste("Height Histograms for ", site_name,sep="")) + 
    scale_x_continuous(limits=c(0,20)) +
    scale_y_continuous(limits=c(0,0.7))

  all_data_summary <- all_data %>%
    group_by(bin,year,site) %>%
    summarize(median = median(frequency),
              q1 = quantile(frequency, 0.25),
              q3 = quantile(frequency, 0.75),
              mean = mean(frequency)) 
}


woodland_values <- makeBoxPlot(histogram_all, woodland, "Woodland")
channel_values <- makeBoxPlot(histogram_all, channel, "Channel")
restoration_values <- makeBoxPlot(histogram_all, restoration, "Restoration")

all_density_stats <- rbind(woodland_values,
                           channel_values,
                           restoration_values)

ggplot(all_density_stats) + 
    geom_line(aes(x=bin*1.5, y=median, group=year, col=as.factor(year))) + 
    facet_wrap(~site)+ 
    ylab("Height (m) ") + 
    xlab("Change in Frequency") +     guides(col=guide_legend(title="Year")) + 
    ggtitle("Vegetation Height Density") + 
    scale_x_continuous(limits=c(0,20)) +
    scale_y_continuous(limits=c(0,0.5))

makeChangeBoxPlot <- function (histogram_data, site_mask, site_name)
{
  site_histogram <- as.data.frame(mask(crop(histogram_data, site_mask), site_mask, updatevalue=NA))
  names(site_histogram) <- c(paste("bin_",1:20,sep=""),
                             paste("bin_",1:20,sep=""))
  
  site_change_histogram <- (site_histogram[,21:40]-site_histogram[,1:20]) %>%
    mutate(site = rep(site_name, n())) %>%
    pivot_longer(1:20, names_to="name", values_to="frequency_change") %>%
    mutate(bin = as.numeric(substr(name, 5,10))) %>% 
    drop_na()
  
  testChangeSignificance <- function(target_bin)
  {
    change_test <- t.test((site_change_histogram %>% filter(bin==target_bin))$frequency_change)
    return(change_test$p.value)
  }
  testChangeMagnitude <- function(target_bin)
  {
    change_test <- t.test((site_change_histogram %>% filter(bin==target_bin))$frequency_change)
    return(change_test$estimate)
  }
  
  print( unlist(lapply(1:20, FUN=testChangeSignificance))[1:12] )
  print( ((unlist(lapply(1:20, FUN=testChangeSignificance))[1:12])<=0.01) * 1 )
  print( unlist(lapply(1:20, FUN=testChangeMagnitude))[1:12] )
  
  print(
    ggplot(data=site_change_histogram) + 
      geom_boxplot(aes(y=frequency_change, x=bin*1.5, group=bin, ), outlier.alpha=0) + 
      ylab("Height (m) ") + 
      xlab("Change in Frequency") +     guides(col=guide_legend(title="Year")) + 
      ggtitle(paste("Height Change for ", site_name,sep="")) + 
      scale_x_continuous(limits=c(0,20)) +
      scale_y_continuous(limits=c(-0.3,0.3))
    )

  return(as.numeric( unlist(lapply(1:20, FUN=testChangeMagnitude))[1:12] ))
  
}

woodland_change <- makeChangeBoxPlot(histogram_all, woodland, "Woodland")
channel_change <- makeChangeBoxPlot(histogram_all, channel, "Channel")
restoration_change <- makeChangeBoxPlot(histogram_all, restoration, "Restoration")

mean_change_df <- data.frame(channel = channel_change,
                             woodland = woodland_change,
                             restoration = restoration_change,
                             bin = 1:length(channel_change)) %>%
    pivot_longer(1:3, names_to="site", values_to="change")

ggplot(mean_change_df) + 
    geom_line(aes(x=bin*1.5, y=change, group=site, col=site)) + 
    ylab("Change in Frequency") + 
    xlab("Height (m)") +     
    guides(col=guide_legend(title="Year")) + 
    ggtitle("Height Change by Site") + 
    scale_x_continuous(limits=c(0,20)) +
    scale_y_continuous(limits=c(-0.05,0.1))

```
